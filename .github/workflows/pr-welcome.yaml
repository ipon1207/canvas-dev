name: PR Welcome Comment

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Welcome Comment on New PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;
            const prNumber = pr.number;
            const title = pr.title;
            const body = pr.body || '';
            
            // PRã‚¿ã‚¤ãƒˆãƒ«ã®åˆ†æ
            const hasConventionalCommit = /^(feat|fix|docs|style|refactor|perf|test|chore|build|ci):/i.test(title);
            
            // Issueç•ªå·ã®ç¢ºèª
            const hasIssueReference = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(body);
            
            // PRã‚µã‚¤ã‚ºã®ç¢ºèª
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;
            
            let sizeEmoji = 'âœ¨';
            let sizeComment = '';
            
            if (totalChanges < 50) {
              sizeEmoji = 'ğŸ¯';
              sizeComment = 'ã¨ã¦ã‚‚å°ã•ãªPRã§ã™ã­ï¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºã§ã™ã€‚';
            } else if (totalChanges < 200) {
              sizeEmoji = 'ğŸ‘';
              sizeComment = 'é©åˆ‡ãªã‚µã‚¤ã‚ºã®PRã§ã™ã­ã€‚';
            } else if (totalChanges < 500) {
              sizeEmoji = 'ğŸ“¦';
              sizeComment = 'ã‚„ã‚„å¤§ãã‚ã®PRã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦åˆ†å‰²ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
            } else {
              sizeEmoji = 'âš ï¸';
              sizeComment = 'ã‹ãªã‚Šå¤§ããªPRã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è² è·ã‚’è€ƒæ…®ã—ã€å¯èƒ½ã§ã‚ã‚Œã°åˆ†å‰²ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚';
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
            let tips = [];
            
            if (!hasConventionalCommit) {
              tips.push('ğŸ’¡ **Tip**: PRã‚¿ã‚¤ãƒˆãƒ«ã¯ `feat:`, `fix:`, `docs:` ãªã©ã§å§‹ã‚ã‚‹ã¨ã€å¤‰æ›´å†…å®¹ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚');
            }
            
            if (!hasIssueReference) {
              tips.push('âš ï¸ **Important**: PRæœ¬æ–‡ã« `Closes #XX` ã‚’è¨˜è¼‰ã—ã¦ã€Issueã¨ç´ä»˜ã‘ã¦ãã ã•ã„ï¼ˆIDD Guardã§ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ï¼‰ã€‚');
            }
            
            if (totalChanges > 500) {
              tips.push('ğŸ“‹ **Suggestion**: å¤§ããªPRã®å ´åˆã€ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç‰¹ã«è¦‹ã¦ã»ã—ã„ç®‡æ‰€ã‚’æ˜ç¤ºã™ã‚‹ã¨ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã™ã€‚');
            }
            
            // æ­“è¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let message = `## ${sizeEmoji} PRã‚’ä½œæˆã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n`;
            message += `@${author} ã•ã‚“ã€Pull Request #${prNumber} ã®ä½œæˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰\n\n`;
            message += `### ğŸ“Š PRæƒ…å ±\n`;
            message += `- **å¤‰æ›´è¡Œæ•°**: +${additions} / -${deletions} (åˆè¨ˆ: ${totalChanges}è¡Œ)\n`;
            message += `- ${sizeComment}\n\n`;
            if (tips.length > 0) {
              message += `### ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯\n` + tips.join('\n\n') + '\n\n';
            }
            if (hasConventionalCommit && hasIssueReference) {
              message += `### âœ… ç´ æ™´ã‚‰ã—ã„ï¼\n\nã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ã‚‚Issueç´ä»˜ã‘ã‚‚å®Œç’§ã§ã™ã€‚CI ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ãŸã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚\n\n`;
            }
            message += `---\n\n`;
            message += `ğŸ“š **å‚è€ƒè³‡æ–™**:\n`;
            message += `- [è‰¯ã„PRã®ä¾‹](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/TEMPLATE_DOCS/examples/good-pull-request.md)\n`;
            message += `- [ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/TEMPLATE_DOCS/code-review-guide.md)\n`;
            message += `- [FAQ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/TEMPLATE_DOCS/faq.md)\n\n`;
            message += `ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€ä½•ã‹è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
